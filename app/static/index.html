<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Agent Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for chat bubbles and scroll behavior */
        #chat-output {
            height: 70vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .user-bubble {
            background-color: #6366f1; /* Indigo-500 */
            color: white;
            border-radius: 1rem 1rem 0 1rem;
            align-self: flex-end;
        }
        .ai-bubble {
            background-color: #e5e7eb; /* Gray-200 */
            color: #1f2937; /* Gray-800 */
            border-radius: 1rem 1rem 1rem 0;
            align-self: flex-start;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen flex flex-col items-center justify-center p-4">

    <!-- Chat Container -->
    <div class="w-full max-w-lg bg-white shadow-xl rounded-xl flex flex-col h-[90vh]">
        
        <!-- Header -->
        <header class="p-4 border-b bg-indigo-600 text-white rounded-t-xl">
            <h1 class="text-xl font-bold">Compassionate Chat Agent</h1>
            <p id="status" class="text-sm font-light"></p>
        </header>

        <!-- Chat Output Area -->
        <main id="chat-output" class="flex-grow p-4 space-y-4">
            <!-- Messages will be appended here -->
            <div class="ai-bubble max-w-[80%] p-3 shadow-md">
                Hello! I'm here to provide support and information about our services. How can I help you today?
            </div>
        </main>

        <!-- Input and Control Area -->
        <footer class="p-4 border-t">
            <div id="loading-indicator" class="hidden text-center py-2 text-indigo-500">
                <svg class="animate-spin h-5 w-5 mr-3 inline text-indigo-500" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Agent is typing...
            </div>
            
            <!-- Hidden Interrupt/Resume Input -->
            <div id="interrupt-area" class="hidden p-3 mb-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm font-medium text-yellow-800 mb-2">
                    <span id="interrupt-request"></span>
                </p>
                <div class="flex space-x-2">
                    <input type="text" id="interrupt-input" placeholder="Enter required information..." 
                           class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    <button id="interrupt-submit" onclick="handleResume()" 
                            class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-150 disabled:opacity-50">
                        Submit
                    </button>
                </div>
            </div>

            <!-- Main Chat Input -->
            <div id="main-input-area" class="flex space-x-3">
                <input type="text" id="user-input" placeholder="Type your message..." 
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                       onkeydown="if(event.key === 'Enter') sendMessage()">
                <button id="send-button" onclick="sendMessage()" 
                        class="px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 disabled:opacity-50">
                    Send
                </button>
            </div>
        </footer>
    </div>

    <script>
        // --- CRUCIAL FIX: Robust Dynamic WebSocket URL ---
        // Ensure that if the page is loaded securely (HTTPS), the WebSocket protocol is WSS.
        const isSecure = window.location.protocol.startsWith('https');
        const protocol = isSecure ? 'wss' : 'ws';
        const host = window.location.host;
        const WS_URL = `${protocol}://${host}/ws/chat`; 
        
        // The rest of the script is unchanged logic, but included for completeness:
        
        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const statusElement = document.getElementById('status');
        const loadingIndicator = document.getElementById('loading-indicator');
        const interruptArea = document.getElementById('interrupt-area');
        const interruptRequest = document.getElementById('interrupt-request');
        const interruptInput = document.getElementById('interrupt-input');
        const interruptSubmit = document.getElementById('interrupt-submit');
        
        let ws = null;
        let sessionId = null;
        let waitingForResume = false;
        let requiredFieldType = null;

        // --- Utility Functions ---

        function scrollToBottom() {
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        function disableInput(reason = "") {
            userInput.disabled = true;
            sendButton.disabled = true;
            statusElement.textContent = reason;
        }

        function enableInput(statusText = "Ready") {
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
            statusElement.textContent = statusText;
        }

        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            disableInput("Agent is processing...");
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            if (!waitingForResume) {
                enableInput("Ready");
            }
        }

        function appendMessage(content, sender) {
            const container = document.createElement('div');
            container.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-[80%] p-3 shadow-md ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            
            bubble.innerHTML = content.replace(/\n/g, '<br>');

            container.appendChild(bubble);
            chatOutput.appendChild(container);
            scrollToBottom();
        }

        // --- WebSocket Connection ---

        function connectWebSocket() {
            if (ws) {
                ws.close();
            }
            disableInput("Connecting...");
            
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log("WebSocket connected.");
                enableInput("Connected");
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'session_id') {
                    sessionId = data.id;
                    statusElement.textContent = `Session ID: ${sessionId}`;
                    console.log(`Received Session ID: ${sessionId}`);

                } else if (data.type === 'response') {
                    appendMessage(data.text, 'ai');
                    hideLoading();

                } else if (data.type === 'interrupt') {
                    handleInterrupt(data);

                } else if (data.type === 'end') {
                    hideLoading();
                    statusElement.textContent = "Conversation ended.";
                    
                } else {
                    console.warn("Unknown message type:", data.type, data);
                }
            };

            ws.onclose = (event) => {
                console.log("WebSocket closed. Attempting to reconnect in 3s...", event.code, event.reason);
                disableInput("Disconnected. Reconnecting...");
                setTimeout(connectWebSocket, 3000); 
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
                ws.close();
            };
        }

        // --- Interrupt/Resume Logic ---

        function handleInterrupt(data) {
            hideLoading(); 
            
            requiredFieldType = data.field;
            waitingForResume = true;
            
            interruptRequest.textContent = data.request;
            interruptArea.classList.remove('hidden');
            
            disableInput("Waiting for required information.");
            interruptInput.focus();
        }

        function handleResume() {
            const resumeValue = interruptInput.value.trim();
            if (!resumeValue) {
                console.log("Please provide the requested information."); // Using console instead of alert
                return;
            }

            const resumeCommand = {
                type: "resume",
                resume_value: { [requiredFieldType]: resumeValue },
            };
            ws.send(JSON.stringify(resumeCommand));

            appendMessage(`[Provided ${requiredFieldType}]: ${resumeValue}`, 'user');
            
            interruptInput.value = '';
            interruptArea.classList.add('hidden');
            waitingForResume = false;
            requiredFieldType = null;
            
            showLoading(); 
        }


        // --- Message Sending ---

        function sendMessage() {
            if (waitingForResume) {
                handleResume();
                return;
            }

            const message = userInput.value.trim();
            if (!message) return;

            const messagePayload = {
                query: message
            };
            ws.send(JSON.stringify(messagePayload));

            appendMessage(message, 'user');
            userInput.value = '';
            
            showLoading();
        }

        // --- Initialization ---
        window.onload = connectWebSocket;
    </script>
</body>
</html>